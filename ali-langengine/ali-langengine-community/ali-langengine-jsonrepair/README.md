# JSON Repair Tool for Large Language Models

## Overview

The `ali-langengine-jsonrepair` package provides robust tools for handling and repairing malformed JSON that is commonly generated by Large Language Models (LLMs). When working with LLMs, JSON parsing errors are frequent due to various issues such as missing commas, unbalanced brackets, or incorrect quoting. This package offers solutions to handle these issues gracefully.

## Key Components

### 1. JsonSafeParser

`JsonSafeParser` is a utility class that provides methods for safely parsing potentially malformed JSON strings. It implements a multi-layered approach to ensure successful parsing:

1. First attempts direct parsing with FastJSON
2. If that fails, tries to repair the JSON using `JsonRepair`
3. Handles type mismatches (e.g., when a JSON object is incorrectly parsed as an array)
4. Falls back to manual fixes for common JSON issues
5. Always returns a valid result (empty object/array if all else fails)

**Main Methods:**
- `parseObject(String jsonStr)`: Safely parses a JSON string into a JSONObject
- `parseArray(String jsonStr)`: Safely parses a JSON string into a JSONArray
- `getValidJsonString(String jsonStr)`: Returns a valid JSON string, repairing if necessary

### 2. JsonRepair

`JsonRepair` is a specialized utility for repairing malformed JSON strings. It can handle various common JSON errors including:

- Missing quotes around keys
- Missing commas between elements
- Trailing commas in arrays and objects
- Single quotes instead of double quotes
- Comments (both // and /* style)
- Unquoted string literals

**Main Methods:**
- `repairJson(String jsonStr)`: Repairs a malformed JSON string and returns the fixed JSON string
- `loads(String jsonStr)`: Repairs and parses a JSON string, returning the parsed object
- `fromFile(String filename)`: Loads and repairs JSON from a file

## Usage Examples

### Basic Usage with JsonSafeParser

```java
import com.alibaba.langengine.jsonrepair.JsonSafeParser;
import com.alibaba.fastjson.JSONObject;

// Parse potentially malformed JSON into a JSONObject
String llmOutput = "{ \"name\": \"John\" \"age\": 30 }"; // Missing comma
JSONObject result = JsonSafeParser.parseObject(llmOutput);
System.out.println(result); // Properly parsed JSONObject

// Parse as array
String arrayOutput = "[ {\"item\": \"one\"}, {\"item\": \"two\", ]"; // Trailing comma
JSONArray array = JsonSafeParser.parseArray(arrayOutput);
System.out.println(array); // Properly parsed JSONArray

// Get valid JSON string
String fixedJson = JsonSafeParser.getValidJsonString(llmOutput);
System.out.println(fixedJson); // "{"name":"John","age":30}"
```

### Using JsonRepair Directly

```java
import com.alibaba.langengine.jsonrepair.JsonRepair;
import com.alibaba.fastjson.JSON;

// Repair malformed JSON
String malformedJson = "{ 'name': 'John', 'age': 30 }"; // Single quotes instead of double
String repairedJson = JsonRepair.repairJson(malformedJson);
System.out.println(repairedJson); // "{"name":"John","age":30}"

// Parse directly with repair
Object parsed = JsonRepair.loads(malformedJson);
System.out.println(parsed); // Parsed object
```

## Common Error Cases Handled

1. **Missing Commas**
   ```
   { "name": "John" "age": 30 }
   ```

2. **Trailing Commas**
   ```
   { "items": [1, 2, 3, ] }
   ```

3. **Comments in JSON**
   ```
   { 
     "name": "John", // This is a comment
     /* This is a block comment */
     "age": 30
   }
   ```

4. **Single Quotes**
   ```
   { 'name': 'John', 'age': 30 }
   ```

5. **Unbalanced Brackets**
   ```
   { "name": "John", "items": [1, 2, 3 }
   ```

6. **Type Mismatches**
   - When a JSON object is incorrectly parsed as an array
   - When a JSON array is incorrectly parsed as an object

## When to Use

This library is particularly useful when:

1. Working with LLM outputs that should be in JSON format
2. Implementing JSON output parsers for LLM responses
3. Needing to ensure robust JSON handling in applications that interact with LLMs
4. Processing user-generated JSON that might contain syntax errors

## Dependencies

- Alibaba FastJSON
- Lombok (for logging)

## Implementation Details

The implementation follows a progressive approach to JSON repair:

1. **Direct Parsing**: First attempts to parse using standard FastJSON methods
2. **Repair and Parse**: If direct parsing fails, uses JsonRepair to fix common issues
3. **Type Correction**: Handles cases where the JSON structure type doesn't match expectations
4. **Manual Fixes**: Applies specific fixes for common error patterns
5. **Fallback**: Returns empty but valid JSON structures if all repair attempts fail

This multi-layered approach ensures maximum resilience when dealing with malformed JSON from LLMs.
